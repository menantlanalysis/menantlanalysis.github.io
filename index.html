<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nighttime Lights Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.25.1.min.js"></script>
  <style>
    body { display: flex; margin: 0; font-family: sans-serif; }
    #sidebar { width: 220px; background: #f4f4f4; padding: 10px; height: 100vh; overflow-y: auto; }
    #main { flex: 1; padding: 10px; overflow-y: auto; }
    .country, .muni { cursor: pointer; padding: 5px; margin: 2px 0; border-radius: 3px; }
    .country:hover, .muni:hover { background: #ddd; }
    .muni { padding-left: 20px; font-size: 0.95em; color: #555; }
    #video { width: 100%; max-height: 360px; }
    #plot { width: 100%; height: 400px; }
  </style>
</head>
<body>

  <div id="sidebar">
    <h3>Countries</h3>
    <div id="countries"></div>
  </div>

  <div id="main">
    <video id="video" controls></video>
    <div id="download-container" style="margin: 10px 0; display: none;">
      <a id="download-link" href="#" download="data.csv">ðŸ“¥ Download CSV Data</a>
    </div>
    <div id="plot"></div>
  </div>

<script>
(async function(){
  const config = await fetch('config.json').then(r=>r.json());
  const events = await fetch('events.json').then(r=>r.json());

  const countriesDiv = document.getElementById('countries');
  const videoEl      = document.getElementById('video');
  const plotEl       = document.getElementById('plot');
  const dlContainer  = document.getElementById('download-container');
  const dlLink       = document.getElementById('download-link');

  async function plotCSV(path, countryKey, muniKey){
    const data = await Plotly.d3.csv(path);
    const dates = data.map(d => new Date(d.date));
    const y     = data.map(d => +d.luminosity);

    const trace = {
      x: dates, y, mode:'markers', name:'Luminosity',
      marker:{size:6, color:'#1f77b4'}
    };
    const trace2 = {
      x: dates, y, mode:'lines', name:'Smoothed',
      line:{shape:'spline', smoothing:0.5, color:'#ff7f0e'}
    };
    const shapes = [];
    const evList = (events[countryKey]?.events || [])
      .concat(events[countryKey]?.municipalities?.[muniKey]?.events || []);
    evList.forEach(ev=>{
      shapes.push({
        type:'rect',
        x0: ev.start, x1: ev.end,
        y0:0, y1:Math.max(...y)*1.1,
        fillcolor:'rgba(200,200,200,0.3)',
        line:{width:0}
      });
    });

    Plotly.newPlot(plotEl, [trace, trace2], {
      title: `${config.countries[countryKey].displayName}${muniKey ? ' â€” ' + muniKey : ''}`,
      shapes, xaxis:{title:'Date'}, yaxis:{title:'Luminosity'}
    });

    dlLink.href = path;
    dlLink.download = `${countryKey}_${muniKey}_data.csv`;
    dlLink.textContent = 'ðŸ“¥ Download CSV Data';
    dlContainer.style.display = 'block';
  }

  Object.entries(config.countries).forEach(([countryKey, countryCfg])=>{
    const countryDiv = document.createElement('div');
    countryDiv.textContent = countryCfg.displayName;
    countryDiv.className = 'country';
    countryDiv.onclick = ()=>selectCountry(countryKey);
    countriesDiv.append(countryDiv);

    // Municipalities
    Object.keys(countryCfg.municipalities).forEach(muniKey=>{
      const muniDiv = document.createElement('div');
      muniDiv.textContent = muniKey;
      muniDiv.className = 'muni';
      muniDiv.onclick = ()=>selectMunicipality(countryKey, muniKey);
      countriesDiv.append(muniDiv);
    });
  });

  async function selectCountry(countryKey){
    const c = config.countries[countryKey];
    videoEl.src = c.video;
    plotEl.innerHTML = '';
    dlContainer.style.display = 'none';
  }

  async function selectMunicipality(countryKey, muniKey){
    const muniCfg = config.countries[countryKey].municipalities[muniKey];
    videoEl.src = muniCfg.video;
    await plotCSV(muniCfg.csv, countryKey, muniKey);
  }

})();
</script>
</body>
</html>